@using WebApi.Infrastructure.Models.Enums
@model WebApi.Infrastructure.Models.DTO.TestForClientDto

@{
    ViewBag.Title = "–†–µ—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞";
    Layout = "_ClientLayout";

    var testType = (TestTypes)ViewBag.TestType;
}

<div class="test-container">
    @if (testType == TestTypes.Exam)
    {
        <div class="test-timer" id="timer">20:00</div>
    }

    <div class="test-card" id="testCard"></div>
    <div class="test-nav" id="testNav"></div>
    <div id="extraNavContainer" style="margin-top:12px;"></div>
</div>

<div class="modal-overlay" id="resultModal" style="display:none;">
    <div class="result-modal">
        <h2 id="resultTitle"></h2>
        <p id="resultText"></p>
        <div class="modal-actions">
            <button onclick="closeModal()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤–æ–ø—Ä–æ—Å–∞–º</button>
            <button class="restart" onclick="restartTest()">–ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ</button>
        </div>
    </div>
</div>

<style>

    .test-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .test-card {
        background: #fff;
        border-radius: 14px;
        padding: 24px;
        box-shadow: 0 6px 18px rgba(0,0,0,.08);
    }

    .test-question {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 16px;
    }

    .test-image-wrapper {
        width: 100%;
        max-height: 350px;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #f6f7f9;
        border-radius: 12px;
        overflow: hidden;
    }

    .test-image-wrapper img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .test-answers {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .answer-btn {
        padding: 14px 16px;
        border-radius: 10px;
        border: 1px solid #ddd;
        background: #f4f6f9;
        cursor: pointer;
        font-size: 15px;
        transition: .15s;
        outline: none;
    }

    .answer-btn.correct {
        background: #e6f6ea;
        border-color: #4caf50;
    }

    .answer-btn.wrong {
        background: #fdecea;
        border-color: #f44336;
    }

    .answer-btn.exam {
        background: #e3e3e3;
        border-color: #c0c0c0;
    }

    .test-hint {
        margin-top: 14px;
        background: #fff8e1;
        padding: 12px 14px;
        border-radius: 10px;
        color: #856404;
    }

    .test-nav {
        margin-top: 24px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .test-nav button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: #e3e7ee;
        cursor: pointer;
        font-weight: 600;
    }

    .test-nav button.active {
        background: #0275d8;
        color: #fff;
    }

    .test-nav button.correct {
        background: #4caf50;
        color: #fff;
    }

    .test-nav button.wrong {
        background: #f44336;
        color: #fff;
    }

    .test-nav button.exam {
        background: #c0c0c0;
        color: #fff;
    }

    .test-timer {
        text-align: right;
        font-weight: 600;
        color: #d9534f;
        margin-bottom: 12px;
    }

    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
    }

    .result-modal {
        background: #fff;
        border-radius: 16px;
        padding: 28px;
        width: 420px;
        max-width: 90%;
        text-align: center;
        box-shadow: 0 12px 30px rgba(0,0,0,.2);
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
        margin-top: 20px;
    }

    .modal-actions button {
        padding: 10px 18px;
        border-radius: 8px;
        border: none;
        background: #0275d8;
        color: #fff;
        cursor: pointer;
        font-weight: 600;
    }

    .modal-actions button.restart {
        background: #5cb85c;
    }

    .test-nav button.correct {
        background: #4caf50;
        color: #fff;
    }

    .test-nav button.wrong {
        background: #f44336;
        color: #fff;
    }

    .test-nav button.exam {
        background: #c0c0c0;
        color: #fff;
    }
</style>

<script>
    const tasks = @Html.Raw(Json.Serialize(Model.Tasks));
    const additionalQuestions = @Html.Raw(Json.Serialize(Model.AdditionalQuestions));
    const testType = '@testType';
    const testId = '@ViewBag.TestId';
    const STORAGE_KEY = `test_${testId}`;

    let current = 0;
    let finished = false;

    let examAnswers = {};
    let extraQuestions = [];
    let extraAnswers = {};
    const answersState = JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}');

    if (localStorage.getItem(`${STORAGE_KEY}_finished`) === 'true') finished = true;

    function renderTask(index, isExtra = false) {
        const task = isExtra ? extraQuestions[index] : tasks[index];
        current = index;

        let html = '';
        if (task.filePath) html += `<div class="test-image-wrapper"><img src="${task.filePath}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ"></div>`;
        html += `<div class="test-question">${task.text}</div><div class="test-answers">`;

        task.answerVariants.filter(a => a).forEach(a => {
            let cls = '';

            if (finished) {
                const selected = isExtra
                    ? extraAnswers[task.id]
                    : examAnswers[task.id];

                if (a === task.correctAnswer) cls = 'correct';
                else if (a === selected) cls = 'wrong';
            } else if (testType === 'Exam') {
                const selected = isExtra
                    ? extraAnswers[task.id]
                    : examAnswers[task.id];

                if (selected === a) cls = 'exam';
            } else {
                const state = answersState[task.id];
                if (state) cls = state.isCorrect
                    ? (a === task.correctAnswer ? 'correct' : '')
                    : (a === state.selected ? 'wrong' : (a === task.correctAnswer ? 'correct' : ''));
            }

            html += `<button class="answer-btn ${cls}" data-answer="${a}" data-task-id="${task.id}" data-extra="${isExtra}">${a}</button>`;
        });

        html += `</div>`;
        document.getElementById('testCard').innerHTML = html;

        renderNav(isExtra);
    }

    function renderNav(isExtra = false) {
        const list = isExtra ? extraQuestions : tasks;
        let nav = '';

        for (let i = 0; i < list.length; i++) {
            let cls = '';
            const task = list[i];
            if (i === current) cls += ' active';

            if (finished) {
                // —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –≤ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
                const selected = examAnswers[task.id] || extraAnswers[task.id];
                if (selected === task.correctAnswer) cls += ' correct';
                else cls += ' wrong';
            } else if (testType === 'Exam') {
                const selected = examAnswers[task.id] || extraAnswers[task.id];
                if (selected) cls += ' exam';
            } else {
                const state = answersState[task.id];
                if (state) cls += state.isCorrect ? ' correct' : ' wrong';
            }

            nav += `<button class="${cls}" onclick="renderTask(${i}, ${isExtra})">${i + 1}</button>`;
        }

        if (isExtra) {
            document.getElementById('extraNavContainer').innerHTML = `
        <div style="font-weight:600; margin-bottom:4px;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã</div>
        <div class="test-nav">${nav}</div>
    `;
        } else {
            document.getElementById('testNav').innerHTML = nav;

            if (extraQuestions.length > 0) renderNav(true);
        }
    }

    function restoreState(task) {
        const state = answersState[task.id];
        if (!state) return;
        document.querySelectorAll('.answer-btn').forEach(b => {
            if (b.innerText === task.correctAnswer) b.classList.add('correct');
            else if (b.innerText === state.selected) b.classList.add('wrong');
            b.disabled = true;
        });
        if (!state.isCorrect && task.hint) {
            document.getElementById('testCard').insertAdjacentHTML('beforeend', `<div class="test-hint">üí° ${task.hint}</div>`);
        }
    }

    document.addEventListener('click', e => {
        if (!e.target.classList.contains('answer-btn')) return;

        const selected = e.target.dataset.answer;
        const taskId = e.target.dataset.taskId;
        const isExtra = e.target.dataset.extra === 'true';
        if (finished) return;

        if (testType === 'Exam') {
            if (isExtra) extraAnswers[taskId] = selected;
            else examAnswers[taskId] = selected;

            // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç —Å–µ—Ä—ã–º —Å—Ä–∞–∑—É
            document.querySelectorAll('.answer-btn').forEach(b => {
                b.classList.remove('exam'); // —É–±–∏—Ä–∞–µ–º —Å –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
                if (b.dataset.answer === selected) b.classList.add('exam');
            });

            renderNav(isExtra);
            checkFinish();
        } else {
            answer(selected);
        }
    });

    function answer(selected) {
        if (finished) return;
        const task = tasks[current];
        if (answersState[task.id]) return;

        const isCorrect = selected === task.correctAnswer;
        answersState[task.id] = {selected, isCorrect};
        localStorage.setItem(STORAGE_KEY, JSON.stringify(answersState));

        fetch('/ClientMvc/SaveAnswer', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({taskId: task.id, isCorrect})
        });

        document.querySelectorAll('.answer-btn').forEach(b => {
            if (b.innerText === task.correctAnswer) b.classList.add('correct');
            else if (b.innerText === selected) b.classList.add('wrong');
            b.disabled = true;
        });

        if (!isCorrect && task.hint) {
            document.getElementById('testCard').insertAdjacentHTML('beforeend', `<div class="test-hint">üí° ${task.hint}</div>`);
        }
        renderNav();
        checkFinish();
    }

    function getStats() {
        const values = Object.values(answersState);
        const correct = values.filter(v => v.isCorrect).length;
        const wrong = values.filter(v => !v.isCorrect).length;
        return {correct, wrong, total: tasks.length};
    }

    function checkFinish() {
        if (testType === 'Themes' || testType === 'ChallengingQuestions') {
            const stats = getStats();
            if (stats.correct + stats.wrong === stats.total) finishThemesAndChallengingQuestions(stats.wrong);
        }
        if (testType === 'Marathon') {
            const stats = getStats();
            if (stats.wrong >= 1) finishMarathon(false);
            else if (stats.correct === stats.total) finishMarathon(true);
        }
        if (testType === 'Exam') checkFinishExam();
    }

    function getStatsExam() {
        const values = Object.entries(examAnswers);
        const answered = values.length;
        const total = tasks.length;
        const themeErrors = {};
        values.forEach(([taskId, selected]) => {
            const task = tasks.find(t => t.id == taskId);
            if (!task) return;
            if (selected !== task.correctAnswer) {
                themeErrors[task.themeId] = (themeErrors[task.themeId] || 0) + 1;
            }
        });
        const totalErrors = Object.values(themeErrors).reduce((a, b) => a + b, 0);
        return {answered, total, themeErrors, totalErrors};
    }

    function checkFinishExam() {
        // —Å—á–∏—Ç–∞–µ–º –æ—Ç–≤–µ—Ç—ã —Ç–æ–ª—å–∫–æ –ø–æ –æ—Å–Ω–æ–≤–Ω—ã–º –≤–æ–ø—Ä–æ—Å–∞–º
        const stats = getStatsExam();
        console.log(stats)
        
        // –µ—Å–ª–∏ –≤—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –æ—Ç–≤–µ—á–µ–Ω—ã
        if (stats.answered === stats.total) {
            const failedTheme = Object.values(stats.themeErrors).some(c => c >= 1);
            const failedTotal = stats.totalErrors > 2;

            // –µ—Å–ª–∏ –µ—Å—Ç—å –æ—à–∏–±–∫–∏ –∏ –¥–æ–ø. –≤–æ–ø—Ä–æ—Å—ã –µ—â—ë –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
            console.log(failedTheme);
            console.log(failedTotal);
            console.log(extraQuestions);
            if ((failedTheme || failedTotal) && extraQuestions.length === 0) {
                extraQuestions = [];
                for (let themeId in stats.themeErrors) {
                    const extra = additionalQuestions[themeId]?.slice(0, 5);
                    console.log(extra);
                    if (extra) extraQuestions.push(...extra);
                }
                
                if (extraQuestions.length > 0) {
                    // –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é, –Ω–µ –º–µ–Ω—è—è —Ç–µ–∫—É—â–∏–π –∏–Ω–¥–µ–∫—Å
                    renderNav(false); // –æ—Å–Ω–æ–≤–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
                    renderNav(true);  // –¥–æ–ø. –≤–æ–ø—Ä–æ—Å—ã
                    return;
                }
            }

            // –µ—Å–ª–∏ –¥–æ–ø. –≤–æ–ø—Ä–æ—Å—ã —É–∂–µ –æ—Ç–≤–µ—á–µ–Ω—ã –∏–ª–∏ –Ω–µ –Ω—É–∂–Ω—ã ‚Äî –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ–º —ç–∫–∑–∞–º–µ–Ω
            if (extraQuestions.length > 0) {
                // –ø—Ä–æ–≤–µ—Ä—è–µ–º, –æ—Ç–≤–µ—á–µ–Ω—ã –ª–∏ –≤—Å–µ –¥–æ–ø. –≤–æ–ø—Ä–æ—Å—ã
                const allExtraAnswered = extraQuestions.every(q => extraAnswers[q.id]);
                if (!allExtraAnswered) return; // –∂–¥–µ–º –æ—Ç–≤–µ—Ç—ã –Ω–∞ –¥–æ–ø. –≤–æ–ø—Ä–æ—Å—ã
            }

            finishExam();
        }
    }

    function finishExam() {
        finished = true;

        if (examTimer) clearInterval(examTimer); // –æ—Å—Ç–∞–Ω–æ–≤–∏–º —Ç–∞–π–º–µ—Ä

        const allAnswers = {...examAnswers, ...extraAnswers};
        const themeErrors = {};

        Object.entries(allAnswers).forEach(([taskId, selected]) => {
            const task = tasks.find(t => t.id == taskId) || extraQuestions.find(t => t.id == taskId);
            if (!task) return;

            if (selected !== task.correctAnswer) {
                themeErrors[task.themeId] = (themeErrors[task.themeId] || 0) + 1;
            }
        });

        const totalErrors = Object.values(themeErrors).reduce((a, b) => a + b, 0);
        const failedTheme = Object.values(themeErrors).some(c => c >= 2);

        showModal((totalErrors > 2 || failedTheme) ? "–≠–∫–∑–∞–º–µ–Ω –Ω–µ —Å–¥–∞–Ω" : "–≠–∫–∑–∞–º–µ–Ω —Å–¥–∞–Ω", `–í—Å–µ–≥–æ –æ—à–∏–±–æ–∫: ${totalErrors}`);

        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤—Å–µ –æ—Ç–≤–µ—Ç—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏/–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏
        document.querySelectorAll('.answer-btn').forEach(btn => {
            const taskId = btn.dataset.taskId;
            const selected = allAnswers[taskId];
            const task = tasks.find(t => t.id == taskId) || extraQuestions.find(t => t.id == taskId);
            if (!task) return;

            btn.classList.remove('exam');
            if (btn.dataset.answer === task.correctAnswer) {
                btn.classList.add('correct');
            } else if (btn.dataset.answer === selected) {
                btn.classList.add('wrong');
            }
            btn.disabled = true;
        });

        fetch('/ClientMvc/SaveAnswers', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(allAnswers)
        });
        
        renderNav();
    }

    function finishMarathon(success) {
        finished = true;
        localStorage.setItem(`${STORAGE_KEY}_finished`, 'true');
        showModal(success ? '–ú–∞—Ä–∞—Ñ–æ–Ω —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω' : '–ú–∞—Ä–∞—Ñ–æ–Ω –æ–∫–æ–Ω—á–µ–Ω',
            success ? '–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã!' : '–î–æ–ø—É—â–µ–Ω–∞ –æ—à–∏–±–∫–∞. –ú–∞—Ä–∞—Ñ–æ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω.');
    }

    function finishThemesAndChallengingQuestions(wrongCount) {
        finished = true;
        localStorage.setItem(`${STORAGE_KEY}_finished`, 'true');
        const passed = wrongCount < 2;
        showModal(passed ? '–¢–µ—Å—Ç —Å–¥–∞–Ω' : '–¢–µ—Å—Ç –Ω–µ —Å–¥–∞–Ω',
            `–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${getStats().correct}<br>–û—à–∏–±–æ–∫: ${wrongCount}`);
    }

    function showModal(title, text) {
        document.getElementById('resultTitle').innerText = title;
        document.getElementById('resultText').innerHTML = text;
        document.getElementById('resultModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('resultModal').style.display = 'none';
    }

    function restartTest() {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(`${STORAGE_KEY}_finished`);

        const themeId = @ViewBag.ThemeId;
        const testType = '@testType';

        window.location.href = '@Url.Action("StartTest", "ClientMvc")'
            + `?themeId=${themeId}&testType=${testType}`;
    }

    let examTimer; // —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª

    if (testType === 'Exam') {
        let seconds = 20 * 60;
        examTimer = setInterval(() => {
            seconds--;
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            document.getElementById('timer').innerText = `${m}:${s.toString().padStart(2, '0')}`;
            if (seconds <= 0) {
                clearInterval(examTimer);
                finished = true;
                finishExam(); // –≤—ã–∑—ã–≤–∞–µ–º finishExam, —á—Ç–æ–±—ã –ø–æ–¥—Å–≤–µ—Ç–∏—Ç—å –æ—Ç–≤–µ—Ç—ã
            }
        }, 1000);
    }

    renderTask(current);
</script>
