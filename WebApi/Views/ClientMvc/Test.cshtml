@using WebApi.Infrastructure.Models.Enums
@model WebApi.Infrastructure.Models.DTO.TestForClientDto

@{
    ViewBag.Title = "–†–µ—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞ –ø–æ —Ç–µ–º–µ";
    Layout = "_ClientLayout";

    var testType = (TestTypes)ViewBag.TestType;
}

<div class="test-container">

    @if (testType == TestTypes.Exam)
    {
        <div class="test-timer" id="timer">20:00</div>
    }

    <div class="test-card" id="testCard"></div>
    <div class="test-nav" id="testNav"></div>
</div>
<div class="modal-overlay" id="resultModal" style="display:none;">
    <div class="result-modal">
        <h2 id="resultTitle"></h2>
        <p id="resultText"></p>

        <div class="modal-actions">
            <button onclick="closeModal()">–í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –≤–æ–ø—Ä–æ—Å–∞–º</button>
            <button class="restart" onclick="restartTest()">–ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ</button>
        </div>
    </div>
</div>


<style>
    .test-container {
        max-width: 900px;
        margin: 0 auto;
    }

    .test-card {
        background: #fff;
        border-radius: 14px;
        padding: 24px;
        box-shadow: 0 6px 18px rgba(0, 0, 0, .08);
    }

    .test-question {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 16px;
    }

    .test-image-wrapper {
        width: 100%;
        max-height: 350px;
        margin-bottom: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
        background: #f6f7f9;
        border-radius: 12px;
        overflow: hidden;
    }

    .test-image-wrapper img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
    }

    .test-answers {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .answer-btn {
        padding: 14px 16px;
        border-radius: 10px;
        border: 1px solid #ddd;
        background: #f4f6f9;
        cursor: pointer;
        font-size: 15px;
        transition: .15s;
    }

    .answer-btn.correct {
        background: #e6f6ea;
        border-color: #4caf50;
    }

    .answer-btn.wrong {
        background: #fdecea;
        border-color: #f44336;
    }

    .test-hint {
        margin-top: 14px;
        background: #fff8e1;
        padding: 12px 14px;
        border-radius: 10px;
        color: #856404;
    }

    .test-nav {
        margin-top: 24px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .test-nav button {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: none;
        background: #e3e7ee;
        cursor: pointer;
        font-weight: 600;
    }

    .test-nav button.active {
        background: #0275d8;
        color: #fff;
    }

    .test-nav button.correct {
        background: #4caf50;
        color: #fff;
    }

    .test-nav button.wrong {
        background: #f44336;
        color: #fff;
    }

    .test-timer {
        text-align: right;
        font-weight: 600;
        color: #d9534f;
        margin-bottom: 12px;
    }

    .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, .45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
    }

    .result-modal {
        background: #fff;
        border-radius: 16px;
        padding: 28px;
        width: 420px;
        max-width: 90%;
        text-align: center;
        box-shadow: 0 12px 30px rgba(0, 0, 0, .2);
    }

    .modal h2 {
        margin-bottom: 12px;
    }

    .modal-actions {
        margin-top: 20px;
    }

    .modal-actions button {
        padding: 10px 18px;
        border-radius: 8px;
        border: none;
        background: #0275d8;
        color: #fff;
        cursor: pointer;
        font-weight: 600;
    }

    .modal-actions {
        display: flex;
        gap: 12px;
        justify-content: center;
    }

    .modal-actions button.restart {
        background: #5cb85c;
    }

    .test-nav button {
        outline: none;
    }


</style>

<script>
    const tasks = @Html.Raw(Json.Serialize(Model.Tasks));
    const additionalQuestions = @Html.Raw(Json.Serialize(Model.AdditionalQuestions));
    const testType = '@testType';
    const testId = '@ViewBag.TestId';
    const STORAGE_KEY = `test_${testId}`;

    let current = 0;
    let finished = false;
    let examAnswers = {}; // { taskId: selectedAnswer }
    let extraQuestions = [];
    let extraAnswers = {};

    if (localStorage.getItem(`${STORAGE_KEY}_finished`) === 'true') {
        finished = true;
    }

    const answersState = JSON.parse(
        localStorage.getItem(STORAGE_KEY) || '{}'
    );

    function renderTask(index, isExtra = false) {
        const task = isExtra ? extraQuestions[index] : tasks[index];
        current = index;

        let html = '';

        if (task.filePath) {
            html += `
            <div class="test-image-wrapper">
                <img src="${task.filePath}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏—è">
            </div>
        `;
        }

        html += `
        <div class="test-question">${task.text}</div>
        <div class="test-answers">
    `;

        task.answerVariants.filter(a => a).forEach(a => {
            html += `<button class="answer-btn ${testType === 'Exam' ? 'exam' : ''}" 
                     data-answer="${a}" 
                     data-task-id="${task.id}">${a}</button>`;
        });

        html += `</div>`;
        document.getElementById('testCard').innerHTML = html;

        renderNav(isExtra);
    }

    function renderNav(isExtra = false) {
        const list = isExtra ? extraQuestions : tasks;
        let nav = '';
        for (let i = 0; i < list.length; i++) {
            let cls = testType === 'Exam' ? 'exam' : '';
            if (i === current) cls += ' active';
            nav += `<button class="${cls}" onclick="renderTask(${i}, ${isExtra})">${i + 1}</button>`;
        }
        document.getElementById('testNav').innerHTML = nav;
    }

    function restoreState(task) {
        const state = answersState[task.id];
        if (!state) return;

        document.querySelectorAll('.answer-btn').forEach(b => {
            if (b.innerText === task.correctAnswer)
                b.classList.add('correct');
            else if (b.innerText === state.selected)
                b.classList.add('wrong');

            b.disabled = true;
        });

        if (!state.isCorrect && testType !== 'Exam' && task.hint) {
            document.getElementById('testCard')
                .insertAdjacentHTML('beforeend',
                    `<div class="test-hint">üí° ${task.hint}</div>`);
        }
    }

    document.addEventListener('click', e => {
        if (!e.target.classList.contains('answer-btn')) return;

        const taskId = e.target.dataset.taskId;
        const selected = e.target.dataset.answer;

        if (finished) return;

        if (testType === 'Exam') {
            examAnswers[taskId] = selected;
            renderNav();
        } else {
            answer(e.target.dataset.answer);
        }
    });


    function answer(selected) {
        if (finished) return;

        const task = tasks[current];
        if (answersState[task.id]) return;

        const isCorrect = selected === task.correctAnswer;

        answersState[task.id] = {
            selected,
            isCorrect
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(answersState));

        fetch('/ClientMvc/SaveAnswer', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                taskId: task.id,
                isCorrect: isCorrect
            })
        });

        document.querySelectorAll('.answer-btn').forEach(b => {
            if (b.innerText === task.correctAnswer)
                b.classList.add('correct');
            else if (b.innerText === selected)
                b.classList.add('wrong');

            b.disabled = true;
        });

        if (!isCorrect) {
            if (testType === 'Marathon') {
                alert('–û—à–∏–±–∫–∞! –ú–∞—Ä–∞—Ñ–æ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω');
                finished = true;
                localStorage.setItem(`${STORAGE_KEY}_finished`, 'true');
                return;
            }

            if (testType !== 'Exam' && task.hint) {
                document.getElementById('testCard')
                    .insertAdjacentHTML('beforeend',
                        `<div class="test-hint">üí° ${task.hint}</div>`);
            }
        }

        renderNav();
        checkFinish();
    }

    function getStats() {
        const values = Object.values(answersState);
        const correct = values.filter(v => v.isCorrect).length;
        const wrong = values.filter(v => !v.isCorrect).length;

        return {correct, wrong, total: tasks.length};
    }

    function checkFinish() {
        const {correct, wrong, total} = getStats();

        if (testType === 'Themes') {
            if (correct + wrong === total) {
                finishThemes(wrong);
            }
        }

        if (testType === 'Marathon') {
            if (wrong >= 1) {
                finishMarathon(false);
            } else if (correct === total) {
                finishMarathon(true);
            }
        }

        if (testType === 'Exam') {
            const stats = getStatsExam();

            // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã
            if (stats.answered === stats.total) {
                // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å–ª–æ–≤–∏—è —ç–∫–∑–∞–º–µ–Ω–∞
                const failedTheme = Object.values(stats.themeErrors).some(c => c >= 2);
                const failedTotal = stats.totalErrors > 2;

                if (failedTheme || failedTotal) {
                    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–æ–ø. –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ç–µ–º–µ —Å –æ—à–∏–±–∫–∞–º–∏
                    extraQuestions = [];
                    for (let themeId in stats.themeErrors) {
                        const extra = additionalQuestions[themeId]?.slice(0, 5);
                        if (extra) extraQuestions.push(...extra);
                    }

                    if (extraQuestions.length > 0) {
                        // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø. –≤–æ–ø—Ä–æ—Å—ã
                        renderTask(0, true);
                        return;
                    }
                }

                finishExam();
            }
        }
    }

    function getStatsExam() {
        // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã
        const values = Object.entries(examAnswers); // {taskId: selected}
        let total = tasks.length;
        let answered = values.length;

        // –û—à–∏–±–∫–∏ –ø–æ —Ç–µ–º–µ
        const themeErrors = {};
        values.forEach(([taskId, selected]) => {
            const task = tasks.find(t => t.id === taskId);
            if (!task) return;

            if (selected !== task.CorrectAnswer) {
                if (!themeErrors[task.ThemeId]) themeErrors[task.ThemeId] = 0;
                themeErrors[task.ThemeId]++;
            }
        });

        const totalErrors = Object.values(themeErrors).reduce((a, b) => a + b, 0);

        return {answered, total, themeErrors, totalErrors};
    }

    function finishExam() {
        finished = true;

        // 1. –°–æ–±–∏—Ä–∞–µ–º –æ—Ç–≤–µ—Ç—ã –ø–æ —Ç–µ–º–∞–º
        const themeErrors = {};
        tasks.forEach(t => {
            const selected = examAnswers[t.id];
            if (selected !== t.CorrectAnswer) {
                if (!themeErrors[t.ThemeId]) themeErrors[t.ThemeId] = 0;
                themeErrors[t.ThemeId]++;
            }
        });

        const totalErrors = Object.values(themeErrors).reduce((a, b) => a + b, 0);
        const failedTheme = Object.values(themeErrors).some(c => c >= 2);

        // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ø. –≤–æ–ø—Ä–æ—Å—ã
        let extraFailed = false;
        if (totalErrors > 0 || failedTheme) {
            extraQuestions = [];
            for (let themeId in themeErrors) {
                const extra = additionalQuestions[themeId]?.slice(0, 5);
                if (extra) extraQuestions.push(...extra);
            }

            if (extraQuestions.length > 0) {
                renderTask(0, true);
                return;
            }
        }

        if (totalErrors > 2 || failedTheme || extraFailed) {
            showModal("–≠–∫–∑–∞–º–µ–Ω –Ω–µ —Å–¥–∞–Ω", `–í—Å–µ–≥–æ –æ—à–∏–±–æ–∫: ${totalErrors}`);
        } else {
            showModal("–≠–∫–∑–∞–º–µ–Ω —Å–¥–∞–Ω", ``);
        }

        fetch('/ClientMvc/SaveExamAnswers', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(examAnswers)
        });
    }

    function finishMarathon(success) {
        finished = true;
        localStorage.setItem(`${STORAGE_KEY}_finished`, 'true');

        showModal(
            success ? '–ú–∞—Ä–∞—Ñ–æ–Ω —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ–Ω' : '–ú–∞—Ä–∞—Ñ–æ–Ω –æ–∫–æ–Ω—á–µ–Ω',
            success
                ? '–í—ã –æ—Ç–≤–µ—Ç–∏–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã!'
                : '–î–æ–ø—É—â–µ–Ω–∞ –æ—à–∏–±–∫–∞. –ú–∞—Ä–∞—Ñ–æ–Ω –∑–∞–≤–µ—Ä—à—ë–Ω.'
        );
    }

    function finishThemes(wrongCount) {
        finished = true;
        localStorage.setItem(`${STORAGE_KEY}_finished`, 'true');

        const passed = wrongCount < 2;

        showModal(
            passed ? '–≠–∫–∑–∞–º–µ–Ω —Å–¥–∞–Ω' : '–≠–∫–∑–∞–º–µ–Ω –Ω–µ —Å–¥–∞–Ω',
            `–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: ${getStats().correct}<br>
         –û—à–∏–±–æ–∫: ${wrongCount}`
        );
    }

    function showModal(title, text) {
        document.getElementById('resultTitle').innerText = title;
        document.getElementById('resultText').innerHTML = text;
        document.getElementById('resultModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('resultModal').style.display = 'none';
    }

    function restartTest() {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(`${STORAGE_KEY}_finished`);

        const themeId = @ViewBag.ThemeId;
        const testType = '@testType';

        window.location.href =
            `/ClientMvc/StartTest?themeId=${themeId}&testType=${testType}`;
    }

    if (testType === 'Exam') {
        let seconds = 20 * 60;
        const timer = setInterval(() => {
            seconds--;
            const m = Math.floor(seconds / 60);
            const s = seconds % 60;
            document.getElementById('timer').innerText = `${m}:${s.toString().padStart(2, '0')}`;
            if (seconds <= 0) {
                clearInterval(timer);
                finished = true;
                showModal("–≠–∫–∑–∞–º–µ–Ω –Ω–µ —Å–¥–∞–Ω", "–í—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ");
            }
        }, 1000);
    }

    renderTask(current);
</script>
